<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Evidence-Based Health Plan â€” Reminder Calendar</title>
<style>
:root{
  --bg:#0f1115;
  --panel:#151923;
  --text:#e9eef7;
  --dim:#9aa6b2;
  --line:#273043;
  --accent:#9b5cff;
  --ok:#10b981;
  --sans:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:var(--sans);
  line-height:1.4;
  padding:20px;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:600px;
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
}

h1{
  margin:0 0 8px;
  font-size:1.3rem;
  color:#dfe7ff;
}
.subtitle{
  color:var(--dim);
  font-size:0.9rem;
  margin-bottom:20px;
}

.config-bar{
  background:rgba(39,48,67,.4);
  padding:12px;
  border-radius:12px;
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:12px;
  font-size:0.9rem;
}
.config-bar input{
  width:60px;
  text-align:center;
}

.item-list{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.item{
  background:rgba(39,48,67,.3);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  display:flex;
  align-items:flex-start;
  gap:12px;
  transition:border-color .2s;
}
.item:hover{
  border-color:var(--accent);
}
.chk-wrap{
  padding-top:2px;
}
.chk{
  width:20px; height:20px;
  accent-color:var(--accent);
  cursor:pointer;
}

.details{
  flex:1;
}
.item-head{
  font-weight:700;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.item-badge{
  font-size:0.75rem;
  padding:2px 6px;
  border-radius:4px;
}
.item-badge.med{
  color:var(--accent);
  background:rgba(155,92,255,0.1);
}
.item-badge.check{
  color:var(--ok);
  background:rgba(16,185,129,0.1);
}

.field-row{
  margin-top:8px;
  display:flex; gap:8px;
}
input[type=text], input[type=number]{
  background:rgba(0,0,0,0.3);
  border:1px solid var(--line);
  color:var(--dim);
  padding:6px 8px;
  border-radius:6px;
  font-size:0.85rem;
  font-family:var(--sans);
}
input[type=text]{ width:100%; }

input[type=text]:focus, input[type=number]:focus{
  outline:none;
  border-color:var(--accent);
  color:#fff;
}

.actions{
  margin-top:24px;
  padding-top:16px;
  border-top:1px solid var(--line);
  display:flex;
  flex-direction:column;
  gap:10px;
}

button.primary{
  background:linear-gradient(135deg, rgba(155,92,255,.95), rgba(102,217,239,.6));
  color:#fff;
  border:none;
  border-radius:12px;
  padding:14px;
  font-size:1rem;
  font-weight:700;
  cursor:pointer;
  width:100%;
}
button.primary:hover{ filter:brightness(1.1); }
button.primary:active{ transform:translateY(1px); }

.info-box{
  background:rgba(16,185,129,.1);
  border:1px solid rgba(16,185,129,.3);
  color:var(--ok);
  padding:10px;
  border-radius:8px;
  font-size:0.85rem;
  margin-top:12px;
  display:none;
  text-align:center;
}
</style>
</head>
<body>

<div class="container">
  <h1>Health Reminders</h1>
  <div class="subtitle">
    Review your suggested plan below.<br/>
    <b>Medications</b> are optional (unchecked by default).<br/>
    <b>Screenings</b> are staggered to avoid crowding your calendar.
  </div>

  <div class="config-bar">
    <label for="repeat_count">Remind me monthly for</label>
    <input type="number" id="repeat_count" value="4" min="1" max="12" />
    <span>months (screenings only)</span>
  </div>

  <div class="item-list" id="list">
    <!-- Items injected by JS -->
    <div style="padding:20px;text-align:center;color:var(--dim)">Loading...</div>
  </div>

  <div class="actions">
    <button class="primary" id="btn_download">Download Calendar (.ics)</button>
    <div id="msg" class="info-box">File downloaded! Open it to add events to your calendar.</div>
  </div>
</div>

<script>
// Available Reminders Dictionary
// type: "check" (staggered, monthly count) | "med" (start tomorrow, infinite/daily)
// rrule: optional "DAILY" | "WEEKLY" etc (for meds)
const REMINDERS = {
  colon: {
    title: "Colon Cancer Screening",
    note: "Discuss options (Colonoscopy vs Stool test).",
    phone: "555-0199 (GI Dept)",
    type: "check"
  },
  mammo: {
    title: "Mammogram Screening",
    note: "Standard screening mammogram.",
    phone: "555-0142 (Radiology)",
    type: "check"
  },
  psa: {
    title: "Prostate Screening (PSA)",
    note: "Blood draw for PSA (shared decision).",
    phone: "555-0100 (Lab/PCP)",
    type: "check"
  },
  pap: {
    title: "Cervical Screening (Pap/HPV)",
    note: "Pap smear and/or HPV co-testing.",
    phone: "555-0188 (Ob/Gyn)",
    type: "check"
  },
  eye: {
    title: "Eye Exam (Dilated/Retina)",
    note: "Annual dilated eye exam (Retina check).",
    phone: "555-0123 (Ophthalmology)",
    type: "check"
  },
  dentist: {
    title: "Dental Cleaning & Exam",
    note: "Routine 6-month cleaning.",
    phone: "555-0177 (Dentist)",
    type: "check"
  },
  wellness: {
    title: "Annual Wellness Visit",
    note: "General preventive exam & vitals check.",
    phone: "555-0111 (Primary Care)",
    type: "check"
  },
  a1c_screen: {
    title: "Diabetes Screening (HbA1c)",
    note: "Fasting bloodwork or A1c screening.",
    phone: "555-0100 (Lab)",
    type: "check"
  },
  labs_dm: {
    title: "Diabetic Labs (A1c/Metabolic)",
    note: "Quarterly or Bi-annual monitoring labs.",
    phone: "555-0100 (Lab)",
    type: "check"
  },
  uacr: {
    title: "Urine Microalbumin (UACR)",
    note: "Kidney health check (urine sample).",
    phone: "555-0100 (Lab)",
    type: "check"
  },
  dexa: {
    title: "Bone Density Scan (DEXA)",
    note: "Screening for osteoporosis.",
    phone: "555-0142 (Radiology)",
    type: "check"
  },
  lung: {
    title: "Lung Cancer Screening (LDCT)",
    note: "Low-dose CT scan (requires shared decision).",
    phone: "555-0142 (Radiology)",
    type: "check"
  },
  // Medications (Recurring)
  meds_daily: {
    title: "Daily AM Meds",
    note: "Take daily morning medications.",
    phone: "AM",
    type: "med",
    rrule: "DAILY"
  },
  meds_daily_pm: {
    title: "Daily PM Meds",
    note: "Take daily evening medications.",
    phone: "PM",
    type: "med",
    rrule: "DAILY"
  },
  meds_weekly: {
    title: "Weekly GLP-1 Injection",
    note: "Take weekly GLP-1 (Ozempic/Wegovy etc).",
    phone: "Weekly",
    type: "med",
    rrule: "WEEKLY"
  },
  meds_insulin: {
    title: "Insulin Reminder",
    note: "Check glucose & administer insulin.",
    phone: "Daily",
    type: "med",
    rrule: "DAILY"
  }
};

const $ = (id) => document.getElementById(id);

function getParams(){
  return new URLSearchParams(window.location.search);
}

function render(){
  const params = getParams();
  const list = $("list");
  list.innerHTML = "";

  let foundAny = false;

  // Helper to append item
  const appendItem = (key, data) => {
    foundAny = true;
    const div = document.createElement("div");
    div.className = "item";
    
    // Badge based on type
    let badgeHtml = "";
    if(data.type === "med") badgeHtml = `<span class="item-badge med">Med (${data.rrule})</span>`;
    else badgeHtml = `<span class="item-badge check">To-Do</span>`;
    
    // Default checked state: Meds = Unchecked, Checks = Checked
    const isChecked = (data.type === "med") ? "" : "checked";

    div.innerHTML = `
      <div class="chk-wrap">
        <input type="checkbox" class="chk" id="chk_${key}" ${isChecked} />
      </div>
      <div class="details">
        <div class="item-head">
          <span>${data.title} ${badgeHtml}</span>
        </div>
        <div class="field-row">
          <input type="text" id="note_${key}" value="${data.note}" aria-label="Note" />
        </div>
        <div class="field-row">
          <input type="text" id="phone_${key}" value="${data.phone}" aria-label="Phone/Time" />
        </div>
      </div>
    `;
    list.appendChild(div);
  };

  // Check which keys are present in URL
  Object.keys(REMINDERS).forEach(key => {
    if(key === "meds_daily"){
      if(params.has("meds_daily")){
        appendItem("meds_daily", REMINDERS["meds_daily"]);
        appendItem("meds_daily_pm", REMINDERS["meds_daily_pm"]);
      }
    } 
    else if(key === "meds_daily_pm"){
      // no-op (handled by meds_daily)
    }
    else {
      if(params.has(key)){
        appendItem(key, REMINDERS[key]);
      }
    }
  });

  if(!foundAny){
    list.innerHTML = `<div style="padding:20px;text-align:center;color:#9aa6b2">
      No specific reminders detected in the link. <br/>
      Try generating the link again from the main app.
    </div>`;
    $("btn_download").disabled = true;
  }
}

function generateICS(){
  const events = [];
  const monthlyCount = $("repeat_count").value || 4;
  
  // Strategy: 
  // Meds start Tomorrow. AM = 08:00, PM = 20:00.
  // Checks start Tomorrow. Staggered by day. 10:00.
  
  let staggerOffset = 0;

  const checkboxes = document.querySelectorAll(".chk");
  
  checkboxes.forEach(chk => {
    if(!chk.checked) return;
    
    const key = chk.id.replace("chk_", "");
    const data = REMINDERS[key];
    if(!data) return;

    const note = $(`note_${key}`).value;
    const phone = $(`phone_${key}`).value;
    
    const now = new Date();
    // Start logic
    if(data.type === "check"){
      // Stagger: Tomorrow + offset
      now.setDate(now.getDate() + 1 + staggerOffset);
      staggerOffset++; // next screening item gets pushed another day
    } else {
      // Meds: Always start Tomorrow
      now.setDate(now.getDate() + 1);
    }
    
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    
    // Time logic to prevent "all on a line"
    // Meds: 08:00 (AM) or 20:00 (PM)
    // Checks: 10:00
    let hour = "10"; 
    
    if(data.type === "med"){
      if(key.includes("pm")) hour = "20"; // 8 PM
      else hour = "08"; // 8 AM
    }
    
    const dtStart = `${y}${m}${d}T${hour}0000`;
    const dtEnd   = `${y}${m}${d}T${hour}3000`; // 30 mins

    let desc = `${note} \\nContact/Time: ${phone}`;
    
    // Recurrence logic
    let rruleLine = "";
    if(data.type === "med" && data.rrule){
      // Meds = Infinite (or user manually stops)
      rruleLine = `RRULE:FREQ=${data.rrule}`;
    } else if(data.type === "check"){
      // Checks = Monthly x Count
      rruleLine = `RRULE:FREQ=MONTHLY;COUNT=${monthlyCount}`;
    }

    events.push(`BEGIN:VEVENT
SUMMARY:${data.title}
DTSTART:${dtStart}
DTEND:${dtEnd}
DESCRIPTION:${desc}
${rruleLine}
STATUS:CONFIRMED
END:VEVENT`);
  });

  if(events.length === 0) return null;

  return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//EvidenceHealthPlan//ReminderCal//EN
${events.join("\n")}
END:VCALENDAR`;
}

function download(filename, text) {
  const element = document.createElement('a');
  element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);
  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}

$("btn_download").addEventListener("click", ()=>{
  const icsData = generateICS();
  if(!icsData){
    alert("No items selected.");
    return;
  }
  download("HealthReminders.ics", icsData);
  $("msg").style.display = "block";
});

// Init
render();
</script>

</body>
</html>
